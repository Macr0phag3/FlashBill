<!-- æ˜¥æ—¥æ¨±èŠ±ä¸»é¢˜ä¸“å±åŠ è½½é®ç½© -->
<div id="page-loader" class="page-loader page-loader-sakura">
    <canvas id="matrix-canvas" class="loader-matrix-canvas"></canvas>

    <div class="loader-content">
        <div class="loader-sakura-text">
            <span>æ˜¥æ—¥åŠ è½½ä¸­</span>
            <span class="loader-sakura-icon">ğŸŒ¸</span>
        </div>
    </div>
</div>

<style>
    /* æ¨±èŠ± loader ä¸“å±æ ·å¼ */
    .page-loader-sakura {
        background: linear-gradient(160deg, #fff5f8 0%, #fde8ef 40%, #f9d4e2 100%);
    }

    .loader-sakura-text {
        font-family: 'PingFang SC', 'Hiragino Sans GB', sans-serif;
        font-size: 1rem;
        letter-spacing: 0.2em;
        color: #c0506a;
        display: flex;
        align-items: center;
        gap: 0.5em;
        padding: 0.6em 1.6em;
        border: 1px solid rgba(210, 100, 130, 0.25);
        background: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(12px);
        border-radius: 50px;
        box-shadow:
            0 4px 20px rgba(210, 100, 130, 0.12),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    /* èŠ±æœµå›¾æ ‡æ‘‡æ‘† */
    .loader-sakura-icon {
        animation: sakuraSwing 2s ease-in-out infinite;
        display: inline-block;
        transform-origin: center bottom;
    }

    @keyframes sakuraSwing {

        0%,
        100% {
            transform: rotate(-8deg);
        }

        50% {
            transform: rotate(8deg);
        }
    }
</style>

<script>
    (function () {
        const canvas = document.getElementById('matrix-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const loader = document.getElementById('page-loader');

        // æ£€æŸ¥åŠ è½½å±åŠ¨ç”»å¼€å…³
        if (localStorage.getItem('anim-loader') === 'false') {
            canvas.style.display = 'none';
            return;
        }

        let width, height;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            initPetals();
        }

        window.addEventListener('resize', resize);

        // èŠ±ç“£ç²’å­
        const PETAL_COUNT = 60;
        let petals = [];

        // èŠ±ç“£é¢œè‰²æ± ï¼šç²‰è‰²ç³»
        const PETAL_COLORS = [
            'rgba(255, 182, 193, ALPHA)',  // æµ…ç²‰
            'rgba(255, 150, 170, ALPHA)',  // ä¸­ç²‰
            'rgba(240, 120, 150, ALPHA)',  // æ·±ç²‰
            'rgba(255, 200, 210, ALPHA)',  // ç±³ç²‰
            'rgba(250, 165, 185, ALPHA)',  // æš–ç²‰
        ];

        function createPetal(randomY) {
            return {
                x: Math.random() * width,
                y: randomY ? Math.random() * height : -20,
                // æ¼‚ç§»é€Ÿåº¦
                vx: (Math.random() - 0.5) * 1.2,
                vy: 0.5 + Math.random() * 1.2,
                // æ—‹è½¬
                angle: Math.random() * Math.PI * 2,
                angularV: (Math.random() - 0.5) * 0.06,
                // å¤§å°
                size: 5 + Math.random() * 9,
                // é¢œè‰²
                colorTemplate: PETAL_COLORS[Math.floor(Math.random() * PETAL_COLORS.length)],
                alpha: 0.4 + Math.random() * 0.5,
                // æ‘†åŠ¨
                swingPhase: Math.random() * Math.PI * 2,
                swingSpeed: 0.02 + Math.random() * 0.02,
            };
        }

        function initPetals() {
            petals = [];
            for (let i = 0; i < PETAL_COUNT; i++) {
                petals.push(createPetal(true));
            }
        }

        resize();

        // ç»˜åˆ¶å•ä¸ªèŠ±ç“£ï¼ˆæ¤­åœ† + æ—‹è½¬ï¼‰
        function drawPetal(p) {
            const color = p.colorTemplate.replace('ALPHA', p.alpha.toFixed(2));
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.angle);
            ctx.scale(1, 0.55); // å‹æ‰æˆèŠ±ç“£å½¢çŠ¶

            // å¤–å±‚èŠ±ç“£
            ctx.fillStyle = color;
            ctx.shadowColor = 'rgba(210, 100, 130, 0.3)';
            ctx.shadowBlur = 6;
            ctx.beginPath();
            ctx.ellipse(0, 0, p.size, p.size * 0.6, 0, 0, Math.PI * 2);
            ctx.fill();

            // èŠ±ç“£é«˜å…‰ï¼ˆå†…å±‚è¾ƒäº®ï¼‰
            const hlColor = p.colorTemplate.replace('ALPHA', (p.alpha * 0.5).toFixed(2)).replace(/\d+, \d+, \d+/, '255, 220, 228');
            ctx.fillStyle = hlColor;
            ctx.beginPath();
            ctx.ellipse(-p.size * 0.15, -p.size * 0.1, p.size * 0.45, p.size * 0.22, -0.3, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        let lastDraw = 0;
        const fps = 30;

        function draw(timestamp) {
            if (loader.style.display === 'none') return;
            if (timestamp - lastDraw < 1000 / fps) {
                requestAnimationFrame(draw);
                return;
            }
            lastDraw = timestamp;

            ctx.clearRect(0, 0, width, height);

            for (let p of petals) {
                // æ‘†åŠ¨æ•ˆæœï¼ˆæ­£å¼¦æ¼‚ç§»ï¼‰
                p.swingPhase += p.swingSpeed;
                p.x += p.vx + Math.sin(p.swingPhase) * 0.5;
                p.y += p.vy;
                p.angle += p.angularV;

                // è¶…å‡ºåº•éƒ¨æ—¶ä»é¡¶éƒ¨é‡ç”Ÿ
                if (p.y > height + 30) {
                    Object.assign(p, createPetal(false));
                }
                // è¶…å‡ºå·¦å³è¾¹ç•Œæ—¶æŠ˜è¿”
                if (p.x < -30) p.x = width + 30;
                if (p.x > width + 30) p.x = -30;

                drawPetal(p);
            }

            requestAnimationFrame(draw);
        }

        requestAnimationFrame(draw);
    })();
</script>