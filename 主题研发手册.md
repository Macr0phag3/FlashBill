# FlashBill 主题研发手册

## 1. 强约束

1. **不修改业务脚本行为**：`static/js/**` 的业务逻辑不得因主题变化而改变。
2. **主题包只允许** `manifest.json` + `theme.css`，不允许注入 JS。
3. **不改模板结构**：主题通过 CSS 变量覆盖和选择器覆盖，不要求改动 HTML。
4. **主题切换只改变视觉**：API、筛选、导入、图表数据逻辑必须完全一致。
5. **静态资源必须本地化**：字体、图片等所有资源必须放在主题目录内，通过相对路径引用。禁止使用 Google Fonts、CDN 等外部 URL，系统需保证离线可用。

## 2. 文件结构

```
static/themes/<your-theme-id>/
├── manifest.json      # 主题元数据
└── theme.css          # 主题样式（CSS 变量 + 组件覆盖）
```

## 3. manifest.json 规范

```json
{
  "id": "your-theme-id",
  "name": "主题显示名",
  "description": "主题说明",
  "author": "作者",
  "version": "1.0.0",
  "mode": "dark",
  "order": 30,
  "stylesheet": "themes/your-theme-id/theme.css"
}
```

| 字段 | 必填 | 说明 |
|---|---|---|
| `id` | 是 | 唯一标识，与目录名一致 |
| `name` | 是 | 左上角切换器展示名 |
| `mode` | 是 | `light` 或 `dark`，用于触发 Element Plus 暗色变量 |
| `order` | 否 | 排序值，越小越靠前（默认 1000） |
| `stylesheet` | 是 | 主题 CSS 相对 `static/` 的路径 |

## 4. 运行机制

1. 后端 `core/themes.py` 自动扫描 `static/themes/*/manifest.json`，注入 `theme_registry` 到模板。
2. 前端 `theme-manager.js` 负责：
   - 首屏读取 `localStorage` 并立即设置 `html[data-theme="<id>"]` + `html.dark`（当 `mode=dark`）。
   - 动态更新 `#app-theme-style` 的 `href` 指向主题 CSS。
   - 填充左上角下拉菜单，切换时派发 `app:theme-change` 事件。
3. 主题 CSS 以 `<link>` 方式**最后加载**，优先级高于 `style.css` 和 `pages/*.css`。

## 5. theme.css 编写规则

### 5.1 入口选择器

```css
html[data-theme='your-theme-id'] {
    color-scheme: dark; /* 或 light */
    --bg-color: ...;
    --text-color: ...;
    /* ... 覆盖下方列出的 CSS 变量 */
}
```

### 5.2 必须覆盖的 CSS 变量（完整清单）

以下变量在 `:root`（`style.css`）中定义了 light 默认值。**所有变量都必须在主题中覆盖**，否则会回退到 light 基线。

#### 全局基础

| 变量 | 说明 |
|---|---|
| `--bg-color` | 页面背景色 |
| `--bg-color-secondary` | 次级背景色 |
| `--text-color` | 主文本色 |
| `--text-color-secondary` | 次级文本色 |
| `--border-color` | 边框色 |
| `--shadow-color` | 阴影色 |
| `--text-muted-color` | 静默/辅助文本色 |
| `--font-primary` | 全局字体栈（可通过 `@import` 引入 Google Fonts 等外部字体后覆盖） |
| `--el-font-family` | Element Plus 字体（通常设为 `var(--font-primary)`） |

#### 主题选择器（左上角）

| 变量 | 说明 |
|---|---|
| `--theme-picker-border` | 选择器边框色 |
| `--theme-picker-shadow` | 选择器阴影 |
| `--theme-picker-text` | 选择器文本色 |
| `--theme-picker-bg` | 选择器背景色 |

#### 导航岛屿

| 变量 | 说明 |
|---|---|
| `--nav-island-bg` | 岛屿背景色 |
| `--nav-island-border` | 岛屿边框（含 border 简写） |
| `--nav-island-shadow` | 岛屿阴影 |
| `--island-logo-text` | Logo 文本色 |
| `--island-logo-bg` | Logo 背景色 |
| `--island-logo-shadow` | Logo 阴影 |
| `--island-menu-bg` | 菜单岛背景 |
| `--island-menu-shadow` | 菜单岛阴影 |
| `--island-menu-border-top` | 菜单岛顶部边框 |
| `--island-info-bg` | 信息岛背景 |
| `--island-info-shadow` | 信息岛阴影 |
| `--island-info-border-top` | 信息岛顶部边框 |
| `--island-theme-bg` | 主题切换按钮背景 |
| `--island-theme-color` | 主题切换按钮颜色 |
| `--island-theme-shadow` | 主题切换按钮阴影 |
| `--island-theme-border` | 主题切换按钮边框 |
| `--island-theme-hover-shadow` | 主题切换按钮悬停阴影 |
| `--theme-toggle-btn-color` | 主题切换图标色 |
| `--nav-link-active-bg` | 导航链接激活态背景 |

#### 卡片 / 表格 / 时间线

| 变量 | 说明 |
|---|---|
| `--app-card-shadow` | 卡片通用阴影 |
| `--app-card-border-top` | 卡片顶部边框 |
| `--timeline-dot-shadow` | 时间线圆点阴影 |
| `--timeline-item-bg` | 时间线项背景 |
| `--timeline-item-hover-shadow` | 时间线项悬停阴影 |
| `--text-selection-popup-shadow` | 选中弹窗阴影 |
| `--table-header-text-color` | 表头文本色 |
| `--table-row-hover-bg-color` | 表格行悬停背景 |
| `--table-text-color-regular` | 表格常规文本色 |
| `--table-text-color-primary` | 表格主文本色 |

#### 首页

| 变量 | 说明 |
|---|---|
| `--home-default-category-color` | 默认分类颜色 |
| `--home-default-book-color` | 默认账本颜色 |
| `--home-quota-fallback-1/2/3` | 配额仪表盘备用色 |
| `--home-icon-tag-text` | 图标标签文本色 |
| `--home-box-card-bg-color` | 首页主卡片背景色 |
| `--home-box-card-bg-image` | 首页主卡片背景图（可用渐变） |
| `--home-box-card-border` | 首页主卡片边框 |
| `--home-summary-card-bg` | 摘要卡片背景 |
| `--home-summary-card-border` | 摘要卡片边框 |
| `--home-summary-card-shadow` | 摘要卡片阴影 |
| `--home-summary-card-first-bg` | 第一张摘要卡背景（可用渐变） |
| `--home-summary-card-first-border` | 第一张摘要卡边框 |
| `--home-summary-card-second-bg` | 第二张摘要卡背景 |
| `--home-summary-card-second-border` | 第二张摘要卡边框 |
| `--home-duration-purple` | 天数紫色 |
| `--home-duration-green` | 笔数绿色 |
| `--home-empty-text` | 空状态文本色 |
| `--home-heatmap-empty-text` | 热力图空状态文本色 |
| `--home-tooltip-dot-color` | tooltip 圆点色 |
| `--home-trend-card-bg` | 趋势卡背景 |
| `--home-trend-card-border` | 趋势卡边框 |
| `--home-trend-card-shadow` | 趋势卡阴影 |
| `--home-trend-line-glow-strong` | 趋势线辉光（强） |
| `--home-trend-line-glow-soft` | 趋势线辉光（弱） |
| `--home-quota-card-bg` | 配额卡背景 |
| `--home-quota-card-border` | 配额卡边框 |
| `--home-quota-card-shadow` | 配额卡阴影 |
| `--home-table-card-bg` | 表格卡背景 |
| `--home-table-card-border` | 表格卡边框 |
| `--home-table-card-shadow` | 表格卡阴影 |

#### 首页日历图

| 变量 | 说明 |
|---|---|
| `--home-calendar-text` | 日历文本色 |
| `--home-calendar-tooltip-bg` | 日历 tooltip 背景 |
| `--home-calendar-tooltip-border` | 日历 tooltip 边框 |
| `--home-calendar-tooltip-text` | 日历 tooltip 文本色 |
| `--home-calendar-border` | 日历边框 |
| `--home-calendar-dot-border` | 日历圆点边框 |

#### 首页 ECharts 图表

| 变量 | 说明 |
|---|---|
| `--home-chart-text` | 图表文本色 |
| `--home-chart-axis-label` | 坐标轴标签色 |
| `--home-chart-split-line` | 分割线色 |
| `--home-chart-tooltip-bg` | 图表 tooltip 背景 |
| `--home-chart-tooltip-border` | 图表 tooltip 边框 |
| `--home-chart-tooltip-text` | 图表 tooltip 文本色 |
| `--home-chart-tooltip-shadow` | 图表 tooltip 阴影 |
| `--home-chart-axis-line-color` | 坐标轴线色 |
| `--home-chart-line-gradient-start` | 折线渐变起点色 |
| `--home-chart-line-gradient-end` | 折线渐变终点色 |
| `--home-chart-line-point` | 折线数据点色 |
| `--home-chart-moving-dot` | 移动指示点色 |
| `--home-chart-moving-dot-border` | 移动指示点边框色 |
| `--home-chart-line-shadow-color` | 折线阴影色（`transparent` 关闭） |
| `--home-chart-line-shadow-blur` | 折线阴影模糊（纯数字，无单位） |
| `--home-chart-line-shadow-offset-y` | 折线阴影 Y 偏移（纯数字） |

#### 首页仪表盘

| 变量 | 说明 |
|---|---|
| `--home-chart-gauge-axis-line` | 仪表盘轴线色 |
| `--home-chart-gauge-empty` | 仪表盘空态色 |
| `--home-chart-gauge-over-limit` | 超支色 |
| `--home-chart-gauge-normal` | 正常色 |
| `--home-chart-gauge-title` | 仪表盘标题色 |
| `--home-chart-gauge-detail` | 仪表盘详情色 |
| `--home-chart-gauge-detail-amount` | 仪表盘金额色 |
| `--home-chart-gauge-empty-title` | 空仪表盘标题色 |
| `--home-chart-gauge-empty-detail` | 空仪表盘详情色 |

#### 首页热力图

| 变量 | 说明 |
|---|---|
| `--home-heatmap-level-1` ~ `--home-heatmap-level-10` | 热力图 10 级色阶 |

#### 账本页

| 变量 | 说明 |
|---|---|
| `--books-default-color` | 账本默认色 |
| `--books-score-palette` | 评分环配色（逗号分隔的色值列表） |
| `--books-ring-shadow-fallback` | 评分环阴影备用色 |

### 5.3 组件级覆盖（可选）

深色主题通常还需要覆盖 Element Plus 组件样式。以下是内置 dark 主题的做法，可直接复制后调色：

#### Element Plus 按钮

对 `primary / success / warning / danger / info` 五种类型，分别覆盖按钮的背景、边框、文本色：

```css
html[data-theme='your-theme-id'] .el-button--primary {
    --el-button-bg-color: ...;
    --el-button-border-color: ...;
    --el-button-text-color: ...;
    --el-button-hover-bg-color: ...;
    --el-button-hover-border-color: ...;
    --el-button-hover-text-color: ...;
    --el-button-active-bg-color: ...;
    --el-button-active-border-color: ...;
    --el-button-active-text-color: ...;
}
/* 同理 success / warning / danger / info */
```

Disabled 状态：

```css
html[data-theme='your-theme-id'] .el-button--primary.is-disabled,
html[data-theme='your-theme-id'] .el-button--primary.is-disabled:hover {
    --el-button-disabled-bg-color: ...;
    --el-button-disabled-border-color: ...;
    --el-button-disabled-text-color: ...;
}
```

#### Element Plus 表格

```css
html[data-theme='your-theme-id'] .el-table {
    --el-table-bg-color: transparent;
    --el-table-tr-bg-color: transparent;
    --el-table-header-bg-color: transparent;
    --el-table-header-text-color: var(--table-header-text-color);
    --el-table-row-hover-bg-color: var(--table-row-hover-bg-color);
    --el-text-color-regular: var(--table-text-color-regular);
    --el-text-color-primary: var(--table-text-color-primary);
}
```

#### 首页 box-card

```css
html[data-theme='your-theme-id'] .box-card {
    background-color: var(--home-box-card-bg-color) !important;
    background-image: var(--home-box-card-bg-image) !important;
    border: var(--home-box-card-border) !important;
}
```

> 浅色主题通常不需要这些组件覆盖（Element Plus 默认就是浅色风格）。

## 6. 执行流程

1. 在 `static/themes/` 新建主题目录。
2. 写 `manifest.json`。
3. 写 `theme.css`：先复制 `themes/light/theme.css`（浅色）或 `themes/dark/theme.css`（深色）作为模板，再逐项调色。
4. 启动项目验证：`python app.py`
5. 访问以下页面并在左上角切换主题确认效果：
   - `/` (首页)
   - `/statistics` (统计分析)
   - `/tagging` (新增记账)
   - `/rules` (规则管理)
   - `/categories` (分类管理)
   - `/books` (账本管理)

## 7. 验收清单

- [ ] 左上角可切换到新主题
- [ ] 刷新后主题保持不变
- [ ] 深色主题下 `html.dark` class 存在，浅色下不存在
- [ ] 首页 4 个统计卡、趋势图、配额仪表盘、热力图配色一致
- [ ] 统计分析页图表在切换主题后无空白
- [ ] 账本页评分环默认色与图例一致
- [ ] 导航岛对比度可读
- [ ] Element Plus 按钮风格与主题协调
- [ ] 无控制台报错

## 8. 已内置主题

| ID | 名称 | 模式 | 说明 |
|---|---|---|---|
| `light` | 内置浅色 | light | 默认主题 |
| `dark` | 内置深色 | dark | 含完整组件覆盖，可作为深色主题模板 |
