<!DOCTYPE html>
<html lang="zh">

<head>
    <!-- ==================== Meta 信息 ==================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记账助手</title>

    <!-- ==================== 样式表 ==================== -->
    <!-- Element Plus 组件库 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/element-plus/ele-index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/element-plus/element-plus-dark.css') }}">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 页面专属样式（统一前置加载，确保主题样式可覆盖） -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/books.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/categories.css') }}">
    <!-- 当前激活主题样式（由主题初始化脚本动态更新 href） -->
    <link rel="stylesheet" id="app-theme-style" href="{{ url_for('static', filename='themes/light/theme.css') }}">

    <!-- ==================== 脚本库 ==================== -->
    <script src="{{ url_for('static', filename='vendor/vue/vue.global.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/element-plus/element-plus.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/element-plus/icons-vue.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/axios/axios.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>

    <!-- ==================== 主题初始化（防止闪烁，需在 body 渲染前执行） ==================== -->
    <script>
        window.__STATIC_BASE_URL__ = "{{ url_for('static', filename='') }}";
        window.__THEME_REGISTRY__ = {{ theme_registry | tojson }};

        (function () {
            if (window.ThemeManager) {
                window.ThemeManager.bootstrap();
            }
        })();
    </script>

    {% block head %}{% endblock %}
</head>

<body>
    <!-- 页面特定加载遮罩 (由子模板按需实现) -->
    {% block page_loader %}{% endblock %}

    <!-- ==================== 导航栏 ==================== -->
    <!-- ==================== 导航栏 ==================== -->
    <header class="app-header-wrapper">
        <div class="header-split-container">
            <div class="header-left-group">
                <!-- 岛屿 1: Logo -->
                <a href="/" class="nav-island island-logo">
                    记账助手
                </a>
            </div>

            <!-- 岛屿 2: 导航菜单 (居中) -->
            <nav class="nav-island island-menu nav-menu">
                <a href="/" class="nav-link" id="home-tab">首页</a>
                <a href="/statistics" class="nav-link" id="statistics-tab">统计分析</a>
                <a href="/tagging" class="nav-link" id="tagging-tab">新增记账</a>
                <a href="/rules" class="nav-link" id="rules-tab">规则管理</a>
                <a href="/categories" class="nav-link" id="categories-tab">分类管理</a>
                <a href="/books" class="nav-link" id="books-tab">账本管理</a>
            </nav>

            <div class="header-right-group">
                <!-- 岛屿 3: 设置按钮（右侧） -->
                <button class="nav-island island-settings" id="settingsToggleBtn" aria-label="打开设置">
                    <svg class="settings-gear-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- 移动端汉堡菜单按钮 -->
            <button class="mobile-menu-btn" id="mobileMenuToggle" aria-label="打开菜单">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- ==================== 主内容区 ==================== -->
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <!-- ==================== 设置弹窗 ==================== -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <span class="settings-title">设置</span>
                <button class="settings-close-btn" id="settingsCloseBtn" aria-label="关闭设置">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="settings-body">
                <!-- 主题设置区域 -->
                <div class="settings-section">
                    <div class="settings-section-title">主题</div>
                    <div class="settings-section-content" id="settingsThemeSelectContainer">
                        <el-select v-model="currentTheme" @change="onThemeChange" aria-label="切换主题"
                            popper-class="settings-theme-popper" style="width: 100%" v-cloak>
                            <el-option v-for="theme in themes" :key="theme.id" :label="theme.name || theme.id"
                                :value="theme.id">
                            </el-option>
                        </el-select>
                        <!-- Fallback for non-Vue env -->
                        <select v-if="false" class="settings-select" id="settingsThemeSelect"></select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 页面脚本 ==================== -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initActiveNav();
            initMobileMenu();
            initLogoAnimation();
            initNavTextGlitch();
            initSettingsPanel();
        });

        /**
         * 初始化导航菜单文字故障效果 (Hover 时随机跳变)
         * 使用事件委托 (Event Delegation) 以支持动态生成的元素 (如 Vue 渲染的 el-tabs)
         */
        function initNavTextGlitch() {
            // 目标选择器：导航链接，以及 Element Plus 的 Tab 标签
            const selector = '.island-menu .nav-link, .el-tabs__item';
            const chars = "ｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝ0123456789:.=*+-<>";

            // 在 body 上监听 mouseover (冒泡)
            document.body.addEventListener('mouseover', (e) => {
                const target = e.target.closest(selector);
                if (!target) return;

                // 防止重复触发
                if (target.dataset.isGlitching) return;
                target.dataset.isGlitching = 'true';

                const originalText = target.textContent.trim();
                // 备份原始文本
                target.dataset.originalText = originalText;

                let iteration = 0;
                let intervalId = setInterval(() => {
                    // 每一个字符需要多少次迭代才能确定下来 (速度控制)
                    const revealIndex = Math.floor(iteration / 2);

                    // 已确定的部分
                    const revealedText = originalText.substring(0, revealIndex);

                    // 剩余未确定的部分 (生成乱码)
                    const scrambledRest = originalText
                        .substring(revealIndex)
                        .split('')
                        .map(char => {
                            if (char === ' ') return ' ';
                            if (char.charCodeAt(0) > 255) {
                                return chars[Math.floor(Math.random() * chars.length)] +
                                    chars[Math.floor(Math.random() * chars.length)];
                            }
                            return chars[Math.floor(Math.random() * chars.length)];
                        })
                        .join('');

                    target.textContent = revealedText + scrambledRest;

                    // 全部展示完毕，停止动画
                    if (revealIndex >= originalText.length) {
                        clearInterval(intervalId);
                        // 移除标记但是保留原始文本直到鼠标移出? 
                        // 不，动画结束就结束了。但我们需要保持标记防止 hover 期间再次触发
                        target.dataset.isGlitching = 'done'; // 标记为已完成但还在 hover 状态
                    }

                    iteration++;
                }, 60);

                // 将 intervalId 存入对象以便清理
                target.dataset.glitchInterval = intervalId;

                // 定义清理函数
                const stopGlitch = () => {
                    clearInterval(Number(target.dataset.glitchInterval));
                    // 恢复原始文本
                    if (target.dataset.originalText) {
                        target.textContent = target.dataset.originalText;
                    }
                    delete target.dataset.isGlitching;
                    delete target.dataset.glitchInterval;
                    delete target.dataset.originalText;
                    target.removeEventListener('mouseout', stopHandler);
                };

                // 鼠标移出时停止
                const stopHandler = (outEvent) => {
                    // 确保是真的移出了 target (处理子元素冒泡)
                    if (!target.contains(outEvent.relatedTarget)) {
                        stopGlitch();
                    }
                };

                target.addEventListener('mouseout', stopHandler);
            });
        }

        /**
         * 初始化 Logo 岛屿动画 (随机颜色 + 抖动)
         */
        function initLogoAnimation() {
            const logoIsland = document.querySelector('.island-logo');
            if (!logoIsland) return;

            const changeStyle = () => {
                // 生成随机亮色作为背景 (避免太暗影响阅读)
                const hue = Math.floor(Math.random() * 360);
                const saturation = 70 + Math.random() * 30; // 70-100%
                const lightness = 80 + Math.random() * 15; // 80-95% (亮背景)

                // 深色文本以保证对比度
                const textColor = `hsl(${hue}, ${saturation}%, 20%)`;
                const bgColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                const borderColor = `hsl(${hue}, ${saturation}%, 50%)`;

                // 应用样式
                logoIsland.style.backgroundColor = bgColor;
                logoIsland.style.color = textColor;
                logoIsland.style.boxShadow = `0 0 15px ${borderColor}`;

                // 触发抖动动画
                logoIsland.classList.remove('shake');
                void logoIsland.offsetWidth; // 触发重绘，重置动画
                logoIsland.classList.add('shake');
            };

            // 每 3 秒执行一次
            setInterval(changeStyle, 3000);
        }

        /**
         * 初始化导航栏活动状态
         */
        function initActiveNav() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                    link.setAttribute('aria-current', 'page');
                }
            });
        }

        /**
         * 初始化记账天数显示
         */
        function initRecordDuration() {
            const firstDate = localStorage.getItem('firstBillDate');
            const el = document.getElementById('record-keeping-duration');
            if (el) {
                if (!firstDate) {
                    el.style.fontSize = '12px'; // 稍微调小一点以免太长
                    el.textContent = '(打开 统计分析 -> 数据表格 后自动计算)';
                    return;
                }
                el.style.fontSize = ''; // 恢复默认字体大小
                const days = Math.ceil((new Date() - new Date(firstDate)) / 86400000);
                const years = (days / 365).toFixed(1);
                el.textContent = `已记账 ${days} 天（${years} 年）`;
            }
        }

        /**
         * 初始化移动端菜单
         */
        function initMobileMenu() {
            const menuBtn = document.getElementById('mobileMenuToggle');
            const navMenu = document.querySelector('.nav-menu');

            if (menuBtn && navMenu) {
                menuBtn.addEventListener('click', () => {
                    navMenu.classList.toggle('show');
                });
            }
        }

        /**
         * 初始化设置面板（弹窗开关 + 主题选择器）
         */
        function initSettingsPanel() {
            const overlay = document.getElementById('settingsOverlay');
            const toggleBtn = document.getElementById('settingsToggleBtn');
            const closeBtn = document.getElementById('settingsCloseBtn');
            if (!overlay || !toggleBtn) return;

            // 打开弹窗
            const openSettings = () => {
                overlay.classList.add('is-visible');
                document.body.style.overflow = 'hidden';
            };

            // 关闭弹窗
            const closeSettings = () => {
                overlay.classList.remove('is-visible');
                document.body.style.overflow = '';
            };

            toggleBtn.addEventListener('click', openSettings);
            if (closeBtn) closeBtn.addEventListener('click', closeSettings);

            // 点击遮罩层关闭
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeSettings();
            });

            // ESC 键关闭
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overlay.classList.contains('is-visible')) {
                    closeSettings();
                }
            });

            // 初始化弹窗内的主题选择器（使用 Vue 接管以支持 Element Plus）
            if (window.Vue && window.ElementPlus && window.ThemeManager) {
                const settingsApp = Vue.createApp({
                    setup() {
                        const themes = Vue.ref([]);
                        const currentTheme = Vue.ref('');

                        Vue.onMounted(() => {
                            const registry = window.ThemeManager.getThemes();
                            themes.value = registry.length > 0 ? registry : [
                                { id: 'light', name: '默认主题' }
                            ];
                            currentTheme.value = window.ThemeManager.getCurrentThemeId();

                            // 监听其他页面可能触发的主题变化
                            window.addEventListener('app:theme-change', (e) => {
                                if (e.detail && e.detail.themeId) {
                                    currentTheme.value = e.detail.themeId;
                                }
                            });
                        });

                        const onThemeChange = (val) => {
                            window.ThemeManager.applyTheme(val);
                        };

                        return {
                            themes,
                            currentTheme,
                            onThemeChange
                        };
                    }
                });

                settingsApp.use(window.ElementPlus);
                settingsApp.mount('#settingsThemeSelectContainer');
            } else if (window.ThemeManager) {
                // fall back 到原生初始化
                window.ThemeManager.initThemeSelector('settingsThemeSelect');
            }
        }
    </script>

    {% block scripts %}{% endblock %}
</body>

</html>