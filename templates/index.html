{% extends "base.html" %}

{% block head %}
{{ super() }}
<!-- Element Plus 中文语言包 -->
<script src="{{ url_for('static', filename='vendor/vue/zh-cn.min.js') }}"></script>
{% endblock %}

{% block content %}
<!-- ==================== 账单管理界面 ==================== -->
<div id="app">
    <el-card class="mb-3">
        <!-- 卡片头部：账单类型选择 + 操作按钮 -->
        <template #header>
            <div class="d-flex justify-content-between align-items-center">
                <span>账单数据</span>
                <div class="d-flex gap-2">
                    <el-select v-model="billType" placeholder="选择账单类型" style="width: 100px;">
                        <el-option label="支付宝" value="alipay"></el-option>
                        <el-option label="微信" value="wechat"></el-option>
                    </el-select>
                    <el-upload action="/upload" :on-success="handleUploadSuccess" :on-error="handleUploadError"
                        :before-upload="beforeUpload" :show-file-list="false" :data="{ bill_type: billType }"
                        name="file" accept=".xlsx,text/csv">
                        <el-button type="primary">
                            上传账单
                        </el-button>
                    </el-upload>
                    <el-button type="success" @click="handleExport"
                        :disabled="!filteredBillsData.length">导出账单</el-button>
                    <el-button type="danger" @click="handleClearCache" v-if="hasCache">清除缓存</el-button>
                </div>
            </div>
        </template>

        <!-- 工具栏：统计信息 + 筛选控件 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="stats-box text-muted">
                [[ billStats.total ]] / (tag, [[ billStats.tagTagged ]], [[ billStats.tagPercentage.toFixed(2) ]]% ||
                catg, [[ billStats.categoryTagged ]], [[ billStats.categoryPercentage.toFixed(2) ]]%)
            </div>
            <div class="d-flex align-items-center gap-4">
                <el-checkbox v-model="showUntaggedOnly" @change="handleFilterChange"
                    v-if="isEditing">只看未标记</el-checkbox>
                <el-button type="primary" @click="handleStartTagging" :disabled="!bills.length">
                    [[ isEditing ? '保存数据' : '开始打标' ]]
                </el-button>
                <el-button type="primary" @click="handleBatchTag"
                    :disabled="!isEditing || !selectedBills.length">批量打标</el-button>
                <el-button type="primary" @click="handleAutoTag" :disabled="hasCache || !bills.length">自动打标</el-button>
                <el-input v-model="searchQuery" placeholder="搜索内容（null 为空值）" clearable @input="handleFilterChange"
                    style="width: 170px;"></el-input>
                <el-select v-model="searchField" placeholder="选择字段" @change="handleFilterChange" style="width: 100px;">
                    <el-option label="全部字段" value="all"></el-option>
                    <el-option label="交易对方" value="交易对方"></el-option>
                    <el-option label="商品说明" value="商品说明"></el-option>
                    <el-option label="类别" value="类别"></el-option>
                    <el-option label="标签" value="标签"></el-option>
                </el-select>
                <el-select v-model="mealType" placeholder="餐点类型" @change="handleFilterChange" style="width: 100px;"
                    clearable>
                    <el-option label="时段选择" value=""></el-option>
                    <el-option label="早餐" value="早餐"></el-option>
                    <el-option label="午餐" value="午餐"></el-option>
                    <el-option label="晚餐" value="晚餐"></el-option>
                    <el-option label="夜宵" value="夜宵"></el-option>
                </el-select>
            </div>
        </div>

        <!-- 账单表格 -->
        <div class="table-container">
            <el-table :data="paginatedBills" style="width: 100%" border stripe :max-height="560"
                @sort-change="handleSortChange" :empty-text="emptyText" :row-key="row => row.交易订单号"
                :default-sort="{ prop: '交易时间', order: 'ascending' }" @selection-change="handleSelectionChange"
                v-loading="loading" :virtual-scrolling="true" :scrollbar-always-on="true">
                <!-- 序号列（非编辑模式） -->
                <el-table-column type="index" label="序号" width="60" align="center" fixed="left" v-if="!isEditing">
                    <template #default="scope">[[ (currentPage - 1) * pageSize + scope.$index + 1 ]]</template>
                </el-table-column>
                <!-- 选择列（编辑模式） -->
                <el-table-column type="selection" width="55" align="center" fixed="left"
                    v-if="isEditing"></el-table-column>
                <el-table-column prop="交易订单号" class="hidden-column" />
                <!-- 日期列 -->
                <el-table-column prop="交易时间" label="日期" width="180" align="center" sortable="custom"
                    fixed="left"></el-table-column>
                <!-- 金额列 -->
                <el-table-column prop="金额" label="金额" width="120" align="center" sortable="custom">
                    <template #default="scope">
                        <el-input-number v-if="isEditing" v-model="scope.row.金额" :precision="2" :step="0.01"
                            size="small" @change="markModified(scope.row)" style="width: 90px"
                            :controls="false"></el-input-number>
                        <span v-else>[[ formatAmount(scope.row.金额) ]]</span>
                    </template>
                </el-table-column>
                <!-- 类别列 -->
                <el-table-column prop="类别" label="类别" width="120" align="center" :filters="categoryFilterOptions"
                    :filter-method="filterCategory">
                    <template #default="scope">
                        <el-select v-if="isEditing" v-model="scope.row.类别" size="small" style="width: 80px" clearable
                            @change="handleCategoryChange(scope.row)" filterable>
                            <el-option v-for="cat in categories" :key="cat" :label="cat" :value="cat"></el-option>
                        </el-select>
                        <span v-else>[[ scope.row.类别 ]]</span>
                    </template>
                </el-table-column>
                <!-- 标签列 -->
                <el-table-column prop="标签" label="标签" width="120" align="center" :filters="tagFilterOptions"
                    :filter-method="filterTag">
                    <template #default="scope">
                        <el-select v-if="isEditing" v-model="scope.row.标签" size="small" style="width: 80px" clearable
                            @change="markModified(scope.row)" filterable>
                            <el-option v-for="tag in getTagsForCategory(scope.row.类别)" :key="tag" :label="tag"
                                :value="tag"></el-option>
                        </el-select>
                        <span v-else>[[ scope.row.标签 ]]</span>
                    </template>
                </el-table-column>
                <!-- 其他列 -->
                <el-table-column prop="交易对方" label="交易对方" min-width="120" sortable></el-table-column>
                <el-table-column prop="商品说明" label="商品说明" min-width="120" sortable></el-table-column>
                <el-table-column prop="备注" label="备注" min-width="50">
                    <template #default="scope">
                        <el-input v-if="isEditing" v-model="scope.row.备注" size="small" @change="markModified(scope.row)"
                            style="width: 150px"></el-input>
                        <span v-else>[[ scope.row.备注 ]]</span>
                    </template>
                </el-table-column>
                <el-table-column prop="命中规则" label="命中规则" min-width="150">
                    <template #default="scope">
                        <el-input v-if="isEditing" v-model="scope.row.命中规则" size="small"
                            @change="markModified(scope.row)" style="width: 150px"></el-input>
                        <span v-else>[[ scope.row.命中规则 ]]</span>
                    </template>
                </el-table-column>
            </el-table>

            <!-- 分页器 -->
            <div class="pagination-container" style="display: flex; justify-content: flex-end; margin-top: 10px;">
                <el-pagination v-model:current-page="currentPage" v-model:page-size="pageSize"
                    :page-sizes="[100, 500, 1000, 5000, 10000]" layout="total, sizes, prev, pager, next, jumper"
                    :total="filteredBillsData.length" @size-change="val => { pageSize = val; currentPage = 1; }"
                    @current-change="val => currentPage = val">
                </el-pagination>
            </div>
        </div>
    </el-card>

    <!-- 批量打标对话框 -->
    <el-dialog v-model="batchTagDialogVisible" title="批量打标" width="500px" :close-on-click-modal="false">
        <el-form :model="batchTagForm" label-width="80px">
            <el-form-item label="类别">
                <el-select v-model="batchTagForm.category" placeholder="请选择类别" style="width: 100%">
                    <el-option v-for="cat in categories" :key="cat" :label="cat" :value="cat"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="标签">
                <el-select v-model="batchTagForm.tag" placeholder="请选择标签" style="width: 100%">
                    <el-option v-for="tag in categoryTags[batchTagForm.category] || []" :key="tag" :label="tag"
                        :value="tag"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="备注">
                <el-input v-model="batchTagForm.comment" placeholder="请输入备注"></el-input>
            </el-form-item>
        </el-form>
        <template #footer>
            <el-button @click="batchTagDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="applyBatchTag">确定</el-button>
        </template>
    </el-dialog>
</div>

<!-- ==================== Vue 应用逻辑 ==================== -->
<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;
    const { UploadFilled } = ElementPlusIconsVue;

    // Element Plus 中文配置
    const zhCn = {
        el: {
            table: { confirmFilter: '确定', resetFilter: '清空', clearFilter: '清空', sumText: '合计' },
            pagination: { goto: '前往', pagesize: '条/页', total: '共 {total} 条', pageClassifier: '页', page: '页', prev: '上一页', next: '下一页' },
            select: { loading: '加载中', noMatch: '无匹配数据', noData: '无数据', placeholder: '请选择' }
        }
    };

    const app = createApp({
        delimiters: ['[[', ']]'],
        setup() {
            // ==================== 响应式状态 ====================
            const bills = ref([]);
            const loading = ref(false);
            const isEditing = ref(false);
            const hasCache = ref(false);
            const billType = ref('alipay');

            // 筛选状态
            const searchQuery = ref('');
            const searchField = ref('all');
            const mealType = ref('');
            const showUntaggedOnly = ref(false);
            const sortField = ref('交易时间');
            const sortOrder = ref('ascending');

            // 分类数据
            const categories = ref([]);
            const categoryTags = ref({});

            // 分页状态
            const currentPage = ref(1);
            const pageSize = ref(20);

            // 批量打标
            const selectedBills = ref([]);
            const batchTagDialogVisible = ref(false);
            const batchTagForm = ref({ category: '', tag: '', comment: '' });

            // 统计信息（默认值）
            const DEFAULT_STATS = { total: 0, tagged: 0, percentage: 0, categoryTagged: 0, categoryPercentage: 0, tagTagged: 0, tagPercentage: 0 };
            const billStats = ref({ ...DEFAULT_STATS });

            // ==================== 辅助函数 ====================

            /** 通用 API 调用 */
            const apiCall = async (method, url, data = null) => {
                try {
                    const resp = method === 'get' ? await axios.get(url) : await axios.post(url, data);
                    return resp.data.success ? resp.data : null;
                } catch (e) {
                    console.error(`API 错误 [${url}]:`, e);
                    return null;
                }
            };

            /** 标记数据已修改 */
            const markModified = (row) => row && (row._modified = true);

            /** 生成唯一订单号 */
            const generateOrderId = () => `${billType.value === 'wechat' ? 'WECHAT' : 'ALI'}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            /** 餐点时间判断 */
            const getMealTimeRange = (meal) => ({
                '早餐': [6, 11], '午餐': [11, 14], '晚餐': [17, 20], '夜宵': [[20, 24], [0, 3]]
            })[meal];

            const isInMealTime = (bill, meal) => {
                if (!meal) return true;
                const time = new Date(bill.交易时间);
                const h = time.getHours() + time.getMinutes() / 60;
                const range = getMealTimeRange(meal);
                if (meal === '夜宵') return (h >= 20 && h < 24) || (h >= 0 && h < 3);
                return h >= range[0] && h < range[1];
            };

            /** 搜索匹配 */
            const matchSearch = (bill, query, field) => {
                if (!query) return true;
                const q = query.toLowerCase();
                const fields = field === 'all' ? ['交易时间', '金额', '类别', '标签', '交易对方', '商品说明', '备注', '命中规则'] : [field];
                return fields.some(f => {
                    const v = String(bill[f] || '');
                    return q === 'null' ? !v.trim() : v.toLowerCase().includes(q);
                });
            };

            // ==================== 核心筛选逻辑（统一） ====================

            /** 应用所有筛选条件 */
            const applyFilters = (data) => {
                let result = [...data];
                // 餐点筛选
                if (mealType.value) result = result.filter(b => isInMealTime(b, mealType.value));
                // 搜索筛选
                if (searchQuery.value) result = result.filter(b => matchSearch(b, searchQuery.value, searchField.value));
                // 未标记筛选
                if (showUntaggedOnly.value) result = result.filter(b => !b.类别?.trim());
                // 排序
                if (sortField.value && sortOrder.value) {
                    result.sort((a, b) => {
                        const av = a[sortField.value], bv = b[sortField.value];
                        let cmp = 0;
                        if (sortField.value === '金额') cmp = (parseFloat(av) || 0) - (parseFloat(bv) || 0);
                        else if (sortField.value === '交易时间') cmp = new Date(av) - new Date(bv);
                        else cmp = String(av || '').localeCompare(String(bv || ''));
                        return sortOrder.value === 'ascending' ? cmp : -cmp;
                    });
                }
                return result;
            };

            // 筛选后的数据
            const filteredBillsData = computed(() => applyFilters(bills.value));

            // 分页数据
            const paginatedBills = computed(() => {
                const start = (currentPage.value - 1) * pageSize.value;
                return filteredBillsData.value.slice(start, start + pageSize.value);
            });

            // 空数据提示
            const emptyText = computed(() => bills.value.length ? '没有符合条件的数据' : '未上传文件');

            // 筛选选项
            const generateFilters = (field) => {
                const vals = [...new Set(filteredBillsData.value.map(b => b[field]))].filter(Boolean);
                return [{ text: '(空)', value: '' }, ...vals.map(v => ({ text: v, value: v }))];
            };
            const categoryFilterOptions = computed(() => generateFilters('类别'));
            const tagFilterOptions = computed(() => generateFilters('标签'));
            const filterCategory = (value, row) => value === '' ? !row.类别?.trim() : row.类别 === value;
            const filterTag = (value, row) => value === '' ? !row.标签?.trim() : row.标签 === value;

            // ==================== 数据加载 ====================

            /** 获取账单 */
            const fetchBills = async () => {
                loading.value = true;
                const data = await apiCall('get', '/api/bills');
                bills.value = data?.bills || [];
                await fetchStats();
                loading.value = false;
            };

            /** 获取统计 */
            const fetchStats = async () => {
                const data = await apiCall('get', '/api/bill_stats');
                billStats.value = data?.stats || { ...DEFAULT_STATS };
            };

            /** 获取分类 */
            const fetchCategories = async () => {
                const data = await apiCall('get', '/api/categories');
                if (data) {
                    categories.value = Object.keys(data.categories);
                    categoryTags.value = data.categories;
                }
            };

            /** 检查并加载缓存 */
            const checkProgress = async (silent = false) => {
                const data = await apiCall('get', '/api/check_progress');
                hasCache.value = data?.has_progress || false;
                if (hasCache.value) {
                    const loadData = await apiCall('get', '/api/load_progress');
                    if (loadData?.bills) {
                        bills.value = Array.isArray(loadData.bills) ? loadData.bills : Object.values(loadData.bills);
                        await fetchStats();
                        if (!silent) ElMessage.success('成功加载缓存数据');
                    }
                } else {
                    await fetchBills();
                }
            };

            // ==================== 事件处理 ====================

            /** 筛选变化 */
            const handleFilterChange = () => {
                currentPage.value = 1;
                // 使用 computed 自动更新，无需手动调用
            };

            /** 排序变化 */
            const handleSortChange = ({ prop, order }) => {
                sortField.value = prop;
                sortOrder.value = order;
            };

            /** 类别变化时清空标签 */
            const handleCategoryChange = (row) => {
                row.标签 = '';
                markModified(row);
            };

            /** 获取类别对应的标签 */
            const getTagsForCategory = (cat) => categoryTags.value[cat] || [];

            /** 表格选择变化 */
            const handleSelectionChange = (selection) => selectedBills.value = selection;

            // ==================== 打标操作 ====================

            /** 开始/保存打标 */
            const handleStartTagging = async () => {
                if (isEditing.value) {
                    // 保存进度
                    const billsToSave = bills.value.map(b => b.交易订单号 ? b : { ...b, 交易订单号: generateOrderId() });
                    const resp = await apiCall('post', '/api/save_progress', { bills: billsToSave });
                    if (resp) {
                        isEditing.value = false;
                        hasCache.value = true;
                        showUntaggedOnly.value = false;
                        ElMessage.success('保存进度成功');
                        await checkProgress(true);
                    } else {
                        ElMessage.error('保存进度失败');
                    }
                } else {
                    // 进入打标模式
                    await fetchCategories();
                    isEditing.value = true;
                    showUntaggedOnly.value = true;
                }
            };

            /** 自动打标 */
            const handleAutoTag = async () => {
                loading.value = true;
                const resp = await apiCall('post', '/api/auto_tag');
                if (resp) {
                    await fetchBills();
                    ElMessage.success('自动打标成功');
                } else {
                    ElMessage.error('自动打标失败');
                }
                loading.value = false;
            };

            /** 批量打标 */
            const handleBatchTag = () => {
                if (!selectedBills.value.length) return ElMessage.warning('请先选择要打标的账单');
                batchTagDialogVisible.value = true;
            };

            const applyBatchTag = () => {
                const { category, tag, comment } = batchTagForm.value;
                if (!category && !tag && !comment) return ElMessage.warning('请至少填写一个打标项');
                selectedBills.value.forEach(b => {
                    if (category) b.类别 = category;
                    if (tag) b.标签 = tag;
                    if (comment) b.备注 = comment;
                });
                batchTagDialogVisible.value = false;
                batchTagForm.value = { category: '', tag: '', comment: '' };
                ElMessage.success('批量打标成功');
            };

            // ==================== 文件操作 ====================

            /** 上传前检查 */
            const beforeUpload = async (file) => {
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.csv')) {
                    ElMessage.error('只能上传 xlsx 或 csv 文件！');
                    return false;
                }
                const data = await apiCall('get', '/api/check_progress');
                if (data?.has_progress) {
                    try {
                        await ElMessageBox.confirm('检测到有保存的进度，上传新文件将覆盖当前进度，是否继续？', '警告', {
                            confirmButtonText: '继续',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        return true;
                    } catch { return false; }
                }
                return true;
            };

            /** 上传成功 */
            const handleUploadSuccess = async (response) => {
                if (response.success) {
                    ElMessage.success('上传成功');
                    await fetchBills();
                    // 自动打标
                    const resp = await apiCall('post', '/api/auto_tag');
                    if (resp) await fetchBills();
                } else {
                    ElMessage.error(response.message || '上传失败');
                }
            };

            const handleUploadError = () => ElMessage.error('上传失败');

            /** 导出账单 */
            const handleExport = async () => {
                if (!filteredBillsData.value.length) return ElMessage.warning('没有可导出的数据');
                try {
                    const resp = await axios.post('/api/export', { bills: filteredBillsData.value }, { responseType: 'blob' });
                    const url = window.URL.createObjectURL(new Blob([resp.data]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `账单数据_${new Date().toLocaleDateString()}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    ElMessage.success('导出成功');
                } catch { ElMessage.error('导出失败'); }
            };

            /** 清除缓存 */
            const handleClearCache = async () => {
                try {
                    await ElMessageBox.confirm('确定要清除缓存数据吗？此操作不可恢复', '警告', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    });
                    const resp = await apiCall('post', '/api/clear_cache');
                    if (resp) {
                        hasCache.value = false;
                        bills.value = [];
                        await fetchBills();
                        ElMessage.success('缓存已清除');
                    }
                } catch { }
            };

            // ==================== 生命周期 ====================

            onMounted(checkProgress);

            // ==================== 返回模板绑定 ====================

            return {
                // 状态
                bills, loading, isEditing, hasCache, billType, billStats,
                searchQuery, searchField, mealType, showUntaggedOnly,
                categories, categoryTags, currentPage, pageSize,
                selectedBills, batchTagDialogVisible, batchTagForm,
                // 计算属性
                filteredBillsData, paginatedBills, emptyText,
                categoryFilterOptions, tagFilterOptions,
                // 方法
                handleFilterChange, handleSortChange, handleCategoryChange,
                getTagsForCategory, handleSelectionChange, markModified,
                handleStartTagging, handleAutoTag, handleBatchTag, applyBatchTag,
                beforeUpload, handleUploadSuccess, handleUploadError,
                handleExport, handleClearCache,
                filterCategory, filterTag, formatAmount,
                UploadFilled
            };
        }
    });

    app.use(ElementPlus, { locale: zhCn });
    app.mount('#app');
</script>
{% endblock %}