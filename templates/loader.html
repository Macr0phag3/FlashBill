<!-- 主题加载器分发中心（纯前端实现） -->
<div id="theme-loader-dispatcher"></div>

<!-- 将后端注入的各个主题专属 loader 隐藏包裹在 <template> 内，待 JS 分发 -->
{% for theme in theme_registry %}
{% if theme.loader_html %}
<template id="tpl-loader-{{ theme.id }}">
    {{ theme.loader_html | safe }}
</template>
{% endif %}
{% endfor %}

<script>
    (function () {
        // 1. 获取当前保存在前端的主题
        const themeId = localStorage.getItem('app-theme') || 'light';
        let tpl = document.getElementById('tpl-loader-' + themeId);

        // 2. Fallback: 如果主题没有专属加载页，降级尝试 light、dark
        if (!tpl) tpl = document.getElementById('tpl-loader-light');
        if (!tpl) tpl = document.getElementById('tpl-loader-dark');

        const container = document.getElementById('theme-loader-dispatcher');
        if (tpl && container) {
            // 3. 提取模板并插入 DOM
            const clone = tpl.content.cloneNode(true);

            // 4. Hack: <template> 里的 <script> 插入 DOM 不会自动执行，需要手动重建并替换
            const scripts = clone.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });

            container.appendChild(clone);
        }
    })();
</script>